generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// NextAuth.js Models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    @default("")
  name          String
  preferredName String    // How the user wants to be called by the AI
  dateOfBirth   DateTime? // Date of birth (to calculate age)
  role          String    @default("USER") // USER, ADMIN
  image         String?
  emailVerified DateTime?

  // User preferences (Feature 1.3)
  currency   String @default("COP") // COP, USD, EUR
  language   String @default("es-CO") // es-CO, en-US
  dateFormat String @default("DD/MM/YYYY") // Colombian format
  timezone   String @default("America/Bogota") // UTC-5

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts Account[]
  sessions Session[]

  // Epic 2: Smart Data Import
  bankAccounts BankAccount[]
  transactions Transaction[]
  categories   Category[]
  imports      DataImport[]
  tasks        Task[]

  @@map("users")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

// Epic 2: Smart Data Import Models

model BankAccount {
  id                String   @id @default(cuid())
  userId            String
  name              String
  bankName          String   // "Bancolombia", "Nequi", "Davivienda"
  accountType       String   // "SAVINGS", "CHECKING", "CREDIT_CARD"
  accountNumber     String?
  currency          String   @default("COP")
  currentBalance    Float    @default(0)
  initialBalance    Float    @default(0)
  isActive          Boolean  @default(true)
  importSource      String?  // "CSV", "PDF", "MANUAL"
  lastImportDate    DateTime?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  imports      DataImport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("bank_accounts")
}

model Transaction {
  id             String   @id @default(cuid())
  userId         String
  accountId      String
  categoryId     String?
  amount         Float    // Negative for expenses, positive for income
  description    String
  date           DateTime
  type           String   // "EXPENSE", "INCOME", "TRANSFER"
  importId       String?
  rawDescription String?  // Original text from bank

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  BankAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  import   DataImport?  @relation(fields: [importId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([accountId, date])
  @@map("transactions")
}

model Category {
  id          String   @id @default(cuid())
  name        String   // "Alimentaci√≥n", "Transporte"
  key         String   @unique // "FOOD", "TRANSPORT"
  icon        String   // Lucide icon name
  color       String   // Design system token
  type        String   // "EXPENSE", "INCOME"
  userId      String?  // null = global category

  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  createdAt DateTime @default(now())

  @@index([userId])
  @@map("categories")
}

model DataImport {
  id                   String   @id @default(cuid())
  userId               String
  accountId            String?
  fileName             String
  fileType             String   // "CSV", "PDF"
  status               String   // "PENDING", "PROCESSING", "COMPLETED", "FAILED"
  detectedBank         String?
  reportedBalance      Float?   // Balance reported by bank
  calculatedBalance    Float?   // Balance calculated from transactions
  reconciliationMethod String?  // "OVERRIDE", "AI_FIND", "MANUAL"
  transactionsFound    Int      @default(0)
  errorMessage         String?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  account      BankAccount?  @relation(fields: [accountId], references: [id], onDelete: SetNull)
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("data_imports")
}

model Task {
  id          String    @id @default(cuid())
  userId      String
  title       String
  description String?
  dueDate     DateTime?
  status      String    @default("PENDING") // "PENDING", "COMPLETED"
  type        String    // "IMPORT_REMINDER", "CATEGORIZE", "REVIEW"
  metadata    Json?     // Additional data (accountId, etc)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@map("tasks")
}
